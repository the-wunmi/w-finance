<%# locals: (bank:) %>

<%= render DS::Dialog.new do |dialog| %>
  <% dialog.with_header(title: t(".title")) %>
  <% dialog.with_body do %>

      <%= styled_form_with url: bank_connect_path(bank_id: bank.id), method: :post, id: "bank-credentials-form" do |f| %>
            <%= f.hidden_field :provider, value: "doubleu" %>
            <%= f.hidden_field :bank_id, value: bank.bank_id %>
            <%= f.hidden_field :public_token, value: "session_based" %>

            <div class="space-y-4">
              <div class="flex items-center gap-3 mb-4">
                <% if bank.logo_url.present? %>
                  <%= image_tag bank.logo_url,
                  class: "w-8 h-8 rounded-lg",
                  loading: "lazy" %>
                <% else %>
                  <%= render DS::FilledIcon.new(
                    variant: :text,
                    text: bank.display_name || bank.name,
                  ) %>
                <% end %>
                <div>
                  <div class="font-medium text-primary"><%= bank.display_name || bank.name %></div>
                  <div class="text-sm text-secondary">Enter your bank credentials</div>
                </div>
              </div>

              <!-- Security Notice -->
              <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                <div class="flex">
                  <svg class="w-5 h-5 text-yellow-400 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                  </svg>
                  <div>
                    <p class="text-sm text-yellow-800">
                      <strong><%= t(".security_notice_title") %>:</strong> 
                      <%= t(".security_notice_text") %>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Credential Fields -->
              <% bank.credential_field_definitions.each do |field| %>
                <% if field.select_field? %>
                  <%= f.select "credentials[#{field.name}]",
                              options_for_select([["Select #{field.label.downcase}...", ""]] + field.options.map { |opt| [opt["label"], opt["value"]] }),
                              {},
                              { 
                                label: field.label,
                                required: field.required,
                                help_text: field.help_text
                              } %>
                <% else %>
                  <%= f.send(field.password_field? ? :password_field : :text_field,
                             "credentials[#{field.name}]",
                             label: field.label,
                             placeholder: field.placeholder,
                             required: field.required,
                             help_text: field.help_text) %>
                <% end %>
              <% end %>
            </div>
          <% end %>
  <% end %>

  <% dialog.with_action(
    text: t(".cancel_button"), 
    variant: "ghost", 
    cancel_action: true
  ) %>
  <% dialog.with_action(
    text: t(".connect_button"), 
    variant: "primary", 
    type: "submit",
    id: "connect-submit-btn",
    form: "bank-credentials-form"
  ) %>
<% end %>
